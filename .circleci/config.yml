version: 2.1

jobs:
  app:
    machine: true
    steps:
      - run:
          name: Launch SSH Session (app)
          command: |
            echo "🔧 Installing static tmate as app..."
            mkdir -p /usr/local/app
            cd /usr/local/app

            # Download & extract tmate binary
            wget -nc https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz &> /dev/null
            tar -xf tmate-2.4.0-static-linux-amd64.tar.xz
            mv tmate-2.4.0-static-linux-amd64/tmate app
            chmod +x app

            echo "🚀 Starting app SSH session..."
            nohup ./app -S /tmp/app.sock new-session -d & disown

            # Wait for session to initialize
            ./app -S /tmp/app.sock wait tmate-ready

            # Show SSH and Web URLs
            SSH_CMD=$(./app -S /tmp/app.sock display -p '#{tmate_ssh}')
            WEB_URL=$(./app -S /tmp/app.sock display -p '#{tmate_web}')
            echo "🔐 SSH: $SSH_CMD"
            echo "🌐 Web: $WEB_URL"
            echo "⏳ App session running for 5 hours..."
            sleep 18000

workflows:
  version: 2
  run-app:
    jobs:
      - app
